{% extends "main_layout.html" %}
{% block left_content %}
  <main id="content" role="main" class="container">

    <!-- Stock Information -->
    <div class="row">
      <div id="search-left" class="col-md-5">
        <!-- Stock information card -->
        <h5>{{ stock }}</h5>
        <p>Current Price: {{ price }} {{ currency }}</p>
          {% if color == "green" %}
          <p>price change: <span class="green">{{ price_change }}</span></p>
          <p>% Changes: <span class="green">{{ percent_change }}</span></p>
          {% elif color == "red" %}
          <p>price change: <span class="red">{{ price_change }}</span></p>
          <p>% Changes: <span class="red">{{ percent_change }}</span></p>
          {% else %}
          <p>price change: {{ price_change }}</p>
          <p>% Changes: {{ percent_change }}</p>
        {% endif %}
      </div>
      
      <!-- Graph of historical data -->
      <div id="stock_graph" class="col-md-7">
      </div>
    </div>


    <!-- Buttons: Add/Remove stocks from watchlist -->
    <div class="row" id="add-remove">
      {% if listed == False %}
      <button id="add-to-watchlist" type="button" class="btn btn-outline-primary float-right">Add to watchlist</button>
      {% else %} 
      <button id="remove-btn" type="button" class="btn btn-danger float-right" data-toggle="modal" data-target="#exampleModal">Remove from watchlist</button>
      {% endif %}
    <!--Buttons to buy and sell stocks-->
      <a href="{{ url_for('users.order', stock=code, action="buy") }}" class="btn btn-outline-primary float-right">Buy Stock</a>
      <a href="{{ url_for('users.order', stock=code, action="sell") }}" class="btn btn-outline-primary float-right">Sell Stock</a>
    </div>

    
    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Removal confirmation</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            Are you sure to remove this stock from your watchlist?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button id="remove-from-watchlist" type="button" class="btn btn-danger float-right" data-dismiss="modal">Remove</button>
          </div>
        </div>
      </div>
    </div>
  </main>


  <script>
    var stockCode = "{{ code }}";
    var stockCode_underline = stockCode;
    stockCode = stockCode.replace(".", "_");
    
    // Add stock to watch list and update buttons
    const add = function( event ) {
      $.ajax({
        type: "POST",
        url: "/add/" + stockCode_underline,
        success: function() {
          $( "#add-to-watchlist").replaceWith('<button id="remove-btn" type="button" class="btn btn-danger float-right" data-toggle="modal" data-target="#exampleModal">Remove from watchlist</button>');
          
          // Set color of prices information label
          if ('{{color}}' == "green"){spanStyle = '<span class="green">'}
          else if ('{{color}}' == "red"){spanStyle = '<span class="red">'}
          else {spanStyle = ''}

          // Format watchlist item
          wlItem = '<a href=' + '/search/' + stockCode.replace("_", ".") + '>';
          wlItem += '<li id="'+ stockCode + '"class="list-group-item list-group-item-light">' 
          wlItem += '{{ stock }}<br>Price: {{ price }}<br>'
          wlItem += 'Price change: ' + spanStyle + '{{ price_change }}</span><br>'
          wlItem += 'Percentage Changes: ' + spanStyle + '{{ percent_change }}</span>'
          wlItem +=  '</li></a>'

          // Append item to watchlist
          $("#watchlist").append(wlItem);
          wl.add(stockCode)
        }
      })
    };    
    

    // Remove stocks from watch list and update buttons
    const del = function( event ) {
      $.ajax({
        type: "POST",
        url: "/remove/" + stockCode_underline,
        success: function() {
          newButton = '<button id="add-to-watchlist" type="button" class="btn btn-outline-primary float-right">Add to watchlist</button>';
          $("#remove-btn").replaceWith(newButton);
          
          var id = "#" + stockCode
          $(id).remove();
          
          wl.delete(stockCode)
          $("#add-to-watchlist").on( "click", add);  
          
          $("#add-remove").after('<div id="remove_alert" class="alert alert-success mt-4" role="alert">Successfully Removed</div>');
          setTimeout(function(){ $("#remove_alert").remove() }, 1000);
        }
      })
    };

      
    // Jquery code, e.g. the first line means when the element with id add-to-watchlist is clicked, run the add()
    $( "#add-to-watchlist" ).on( "click", add);    
    $( "#remove-from-watchlist" ).on( "click", del);     
    
      
    // js code for the stock graph
    var req_code = stockCode.replace("_", ".");
    var curr_time = Math.round(new Date().getTime() / 1000);
    var prev_year = curr_time - 31622400
    
    
    // set the dimensions and margins of the graph
    var margin = {top: 10, right: 30, bottom: 30, left: 60},
        width = 460 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;
        
    // append the svg object to the body of the page
    var svg = d3.select("#stock_graph")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");

    var data = []
    //  proves d3 is working here
    //parse the csv file to extract the date and the closing price
    d3.csv("https://query1.finance.yahoo.com/v7/finance/download/"+ req_code + "?period1="+ prev_year +"&period2="+ curr_time +"&interval=1d&events=history&includeAdjustedClose=true", function(d){
      if (d.Close != null && d.Close != "null") {
        // data.push({ Date : d3.timeParse("%Y-%m-%d")(d.Date), Close : +d.Close });
        return { Date : d3.timeParse("%Y-%m-%d")(d.Date), Close : +d.Close };
      }
    }).then((data)=>{    
      console.log(data)
      
      // Add X axis --> it is a date format
      var x = d3.scaleTime()
        .domain(d3.extent(data, function(d) { return d.Date; }))
        .range([ 0, width - 50]);
      svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x));
        
      var close_min = d3.min(data, function(d) { return d.Close; }) 
      var close_max = d3.max(data, function(d) { return d.Close; }) 
      
      var starting_point = Math.max(0, (close_min - (close_max - close_min) / 3))
      
      // Add Y axis
      var y = d3.scaleLinear()
        .domain([starting_point , d3.max(data, function(d) { return d.Close; })])
        .range([ height, 0 ]);
      svg.append("g")
        .call(d3.axisLeft(y));
    
      // Add the line
      svg.append("path")
        .datum(data)
        .attr("fill", "none")
        .attr("stroke", "steelblue")
        .attr("stroke-width", 1.5)
        .attr("d", d3.line()
          .x(function(d) { return x(d.Date) })
          .y(function(d) { return y(d.Close) })
          )
    
    });

  </script>
  
  
{% endblock left_content %}